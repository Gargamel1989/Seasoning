{% extends "base.html" %}

{% block title %}Recepten{% endblock %}

{% block extra_head %}
<script>
    // A function that detects if a user presses the enter key
    // Consider moving this to somewhere more appropriate
    $.fn.pressEnter = function(fn) {  

        return this.each(function() {  
            $(this).bind('enterPress', fn);
            $(this).keydown(function(e) {
                if(e.keyCode == 13)
                {
                    e.preventDefault();
                    return false;
                }
            });
            $(this).keyup(function(e){
                if(e.keyCode == 13)
                {
                  $(this).trigger("enterPress");
                }
            });
        });  
     };
     
	function switch_to_recipes_page(page_num, num_pages) {
		if (page_num > num_pages) {
			page_num = 1;
		} else if (page_num < 1) {
			page_num = num_pages;
		}
		$.post('/recipes/',
			   {'page': page_num})
		.done(function(data) {
			$("#recipe-summaries-include-wrapper").html(data);
    	//	make_hover_effect();
		});
		$("#current-page").text(page_num);
	};
	
	function update_recipes() {
        var url = "/recipes/";
        
        $.ajax({
            type: "POST",
            url: url,
            data: $("form.keywords").serialize(),
            success: function(data) {
                $("#recipe-summaries-wrapper").html(data);
            }
        });
        return false;
    };
    
    
    // Make a timer for search_string updating
    var timer;
	
    $(document).ready(function() {
        // Show the Advanced Search Window
    	$("#advanced-link").click(function() {
    		if ($("#advanced-search").is(":visible")) {
    			$("#advanced-search").slideUp(1000, function() {
    				$("#advanced-link").text("Geavanceerd Zoeken");
    				$("#recipe-summaries-wrapper").css("width", "960px");
                    $("#id_advanced_search").val("False");
    			});
    		} else {
    			$("#recipe-summaries-wrapper").css("width", "720px");
    			$("#advanced-search").slideDown(1000);
    			$("#advanced-link").text("Niet-geavanceerd zoeken");
                $("#id_advanced_search").val("True");
    		}
    		return false;
    	});
    	
    	// Activate the buttons that change the order direction
    	$(".order-arrow").click(function() {
    	    if (!$(this).hasClass("active")) {
    	        var active_order_arrow = $(".order-arrow.active");
    	        active_order_arrow.removeClass("active");
    	        $(this).addClass("active");
    	        if ($(this).hasClass("up")) {
    	            $("#id_sort_order_0").click();
    	        } else {
                    $("#id_sort_order_1").click();
    	        }
    	    }
    	    update_recipes();
    	    return false;
    	})
    	
    	
    	// Activate the buttons for veganism selection
    	$(".veg-choice").each(function() {
    	    if (!$(this).children("input:first").attr("checked")) {
    	        $(this).removeClass("active");
    	    }
    	    $(this).click(function() {
                if ($(this).hasClass("active")) {
                    $(this).removeClass("active");
                    $(this).children("input").prop('checked', false);
                } else {
                    $(this).addClass("active");
                    $(this).children("input").prop('checked', true);
                }
    	    	update_recipes();
                return false;
            });
    	});
    	
    	// Activate the button for the include ingredients operator
    	$("#incl-ings .option").click(function() {
            if (!$(this).hasClass("active")) {
                var active_option = $("#incl-ings .option.active");
                active_option.removeClass("active");
                $(this).addClass("active");
                if ($(this).hasClass("and")) {
                    $("#id_include_ingredients_operator_0").click();
                } else {
                    $("#id_include_ingredients_operator_1").click();
                }
            }
    	   	update_recipes();
            return false;
    	});
        
        // Activate the input field for including ingredients
        $("#include-ingredients-input").pressEnter(function() {
            if ($(this).val() != "") {
                // If the user pressed enter while in the input field, and it contains text,
                // add another ingredient to the filter
                var current_form_num = parseInt($("#id_include-TOTAL_FORMS").val());
                $("#id_include-TOTAL_FORMS").val(current_form_num + 1);
                var empty_form = $("#id_include-__prefix__-name");
                var new_form = empty_form.clone();
                new_form.attr("id", new_form.attr("id").replace("__prefix__", current_form_num));
                new_form.attr("name", new_form.attr("name").replace("__prefix__", current_form_num));
                new_form.val($(this).val());
                new_form.insertBefore(empty_form);
                // Display the new ingredient as being in the filter
                var new_ing = $('<a href="#"><div class="filtered-ingredient">' + $(this).val() + '</div></a>')
                new_ing.click(function() {
                    new_form.remove();
                    $(this).remove();
                	update_recipes();
                    return false;
                });
                $("#included-ingredients").append(new_ing);
                $(this).val("");
    	   		update_recipes();
            }
        });
        
        // Activate the input field for excluding ingredients
        $("#exclude-ingredients-input").pressEnter(function() {
            if ($(this).val() != "") {
                // If the user pressed enter while in the input field, and it contains text,
                // add another ingredient to the filter
                var current_form_num = parseInt($("#id_exclude-TOTAL_FORMS").val());
                $("#id_exclude-TOTAL_FORMS").val(current_form_num + 1);
                var empty_form = $("#id_exclude-__prefix__-name");
                var new_form = empty_form.clone();
                new_form.attr("id", new_form.attr("id").replace("__prefix__", current_form_num));
                new_form.attr("name", new_form.attr("name").replace("__prefix__", current_form_num));
                new_form.val($(this).val());
                new_form.insertBefore(empty_form);
                // Display the new ingredient as being in the filter
                var new_ing = $('<a href="#"><div class="filtered-ingredient">' + $(this).val() + '</div></a>')
                new_ing.click(function() {
                    new_form.remove();
                    $(this).remove();
                	update_recipes();
                    return false;
                });
                $("#excluded-ingredients").append(new_ing);
                $(this).val("");
                update_recipes();
            }
        });
        
        // Update recipe list on filter change
        $("#id_sort_field").change(update_recipes);
        $("input[name='cuisine']").change(update_recipes);
        $("input[name='course']").change(update_recipes);
        
        $("#id_search_string").keyup(function() {
        	if ($(this).val().length >= 3) {
        		timer = setTimeout(update_recipes, 1000);
        	}
        });
        $("#id_search_string").keydown(function() {
        	clearTimeout(timer);
       	});
       	$("#id_search_string").pressEnter(function() {
       		update_recipes;
       		timer = clearTimeout(timer);
       	});

        $("input.autocomplete-ingredient").each(function() {
            $(this).autocomplete({
                source: "/ingredients/ing_list/",
                minLength: 2
            });
        });
    	
    	// TODO: Delete when finished with testing the advanced search
    	$("#advanced-link").click();
    	
		var num_pages = parseInt($("#num-pages").text());
        $('.recipe-summaries-arrow .arrow-left').click(function() {
        	switch_to_recipes_page(parseInt($('#current-page').text()) - 1, num_pages);
        });
        $('.recipe-summaries-arrow .arrow-right').click(function() {
        	switch_to_recipes_page(parseInt($('#current-page').text()) + 1, num_pages);
        });
    });
</script>
{% endblock %}

{% block page_name %}Recepten{% endblock %}

{% block content %}

<form class="keywords" action="" method="post">
    {% csrf_token %}
    <div id="basic-search">
        {{ search_form.search_string }}
	    <button id="keywords-submit" class="nochrome" type="submit">
	        <span class="submit-icon"> </span>
	    </button>
	</div>
	<a id="advanced-link" href="#">
	    Geavanceerd zoeken
	</a>
    {{ search_form.advanced_search.as_hidden }}
    <span id="search-result-count">{{ recipes.start_index }}-{{ recipes.end_index }} van de {{ recipes.paginator.count }} resultaten</span>
    <hr>
    <div id="advanced-search">
        <div id="sorting-options">
            <p>
                Sorteren op:
            </p>
        	{{ search_form.sort_field }}
            <a class="order-arrow up{% if search_form.sort_order.0.is_checked %} active{% endif %}" href="#">
                <img src="{{ STATIC_URL }}img/icons/up.png" title="Sorteer in oplopende volgorde" />
            </a><a class="order-arrow down{% if search_form.sort_order.1.is_checked %} active{% endif %}" href="#">
                <img src="{{ STATIC_URL }}img/icons/down.png" title="Sorteer in aflopende volgorde" />
            </a>
            {{ search_form.sort_order }}
        </div>
    	<div id="veg-options">
    	    <p>
                Voedingswijze:
            </p>
            <a class="veg-choice active" href="#">
            	<img src="{{ STATIC_URL }}img/vegan.png" title="Veganistische Gerechten" />
            	{{ search_form.ven }}
            </a><a class="veg-choice active" href="#">
                <img src="{{ STATIC_URL }}img/vegetarian.png" title="Vegetarische Gerechten" />
                {{ search_form.veg }}
            </a><a class="veg-choice active" href="#">
            	<img src="{{ STATIC_URL }}img/non-vegetarian.png" title="Niet-vegetarische Gerechten" />
            	{{ search_form.nveg }}
            </a>
        </div>
        <div id="incl-ings">
            <p>
                Met ingredienten:
            </p>
            {{ include_ingredients_formset.management_form }}
            <a href="#"><span class="option and first{% if search_form.include_ingredients_operator.0.is_checked %} active{% endif %}">Allemaal</span></a><a href="#"><span class="option or last{% if search_form.include_ingredients_operator.1.is_checked %} active{% endif %}">Minstens 1</span></a>
            {{ search_form.include_ingredients_operator }}
<<<<<<< HEAD
            <input id="include-ingredients-input" class="ingredients-input" placeholder="Voer ingredienten in"/>
=======
            <input id="include-ingredients-input" class="ingredients-input autocomplete-ingredient"/>
>>>>>>> branch 'master' of https://github.com/Gargamel1989/Seasoning.git
            <div id="included-ingredients">
            </div>
            <span class="empty-form">
                {{ include_ingredients_formset.empty_form.name }}
            </span>
        </div>
        <div id="excl-ings">
            <p>
                Zonder ingredienten:
            </p>
            {{ exclude_ingredients_formset.management_form }}
<<<<<<< HEAD
            <input id="exclude-ingredients-input" class="ingredients-input" placeholder="Voer ingredienten in"/>
=======
            <input id="exclude-ingredients-input" class="ingredients-input autocomplete-ingredient"/>
>>>>>>> branch 'master' of https://github.com/Gargamel1989/Seasoning.git
            <div id="excluded-ingredients">
            </div>
            <span class="empty-form">
                {{ exclude_ingredients_formset.empty_form.name }}
            </span>
        </div>
        <div id="extra-info">
            <p>
                Soort keuken:
            </p>
            {{ search_form.cuisine }}
            <p>
                Soort maaltijd:
            </p>
    	   {{ search_form.course }}
    	</div>
    </div>
</form>
<div id="recipe-summaries-wrapper">
	{% include "includes/recipe_summaries.html" %}
</div>

{% endblock %}
