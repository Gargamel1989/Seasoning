{% extends "base.html" %}

{% block title %}Recepten{% endblock %}

{% block extra_link %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/jquery.css" />
<style>
/*
 * Tooltip styles
 */
.ui-tooltip {
    position: absolute;
}

.ui-widget {
    font-family: Verdana,Arial,sans-serif;
    font-size: .75em;
    color: #5B6553;
}
</style>
{% endblock %}

{% block extra_script %}
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script src="{{ STATIC_URL }}js/forms.js"></script>
<script type="text/javascript">
	function add_ingredient() {
		var empty_form = $("#uses-formset .ingredient.empty-form");
		var new_form = empty_form.clone();
		var total_forms = $("#id_uses-TOTAL_FORMS");
		var new_form_number = parseInt(total_forms.val());
		total_forms.val(new_form_number + 1);
		updateFormNumber(new_form, new_form_number);
		new_form.removeClass('empty-form');
		new_form.removeClass('sorting-disabled');
		var last_not_empty_form = $('#uses-formset li.ingredient:not(".empty-form"), #uses-formset li.group:not(".empty-form")').last();
		new_form.insertAfter(last_not_empty_form);
		fix_ingredient_list();
		return false;
	}
	
	function add_group() {
		var empty_group = $("#uses-formset .group.empty-form");
		var new_group = empty_group.clone();
		new_group.removeClass("empty-form");
		new_group.removeClass("sorting-disabled");
		var last_not_empty_form = $('#uses-formset li.ingredient:not(".empty-form"), #uses-formset li.group:not(".empty-form")').last();
		new_group.insertAfter(last_not_empty_form);
		fix_ingredient_list();
		return false;
	}
	
	function fix_ingredient_list() {
		var lis = $("#uses-formset #sortable-ingredients li:not('.column-labels, .empty-form')");
		if (lis.first().hasClass("group")) {
			$("#uses-formset #sortable-ingredients .column-labels").hide();
		} else {
			$("#uses-formset #sortable-ingredients .column-labels").show();
		}
        var group_name = "";
        var found_group = false;
		lis.each(function() {
            if ($(this).hasClass("group")) {
                group_name = $(this).find(".group-name").val();
                found_group = true;
            } else if ($(this).hasClass("ingredient")) {
                $(this).find("input.group").val(group_name);
	            if (found_group) {
	            	$(this).css('padding-left', '50px');
	            } else {
	            	$(this).css('padding-left', '30px');
	            }
            }
        });
        $("#sortable-ingredients .group input").pressEnter(function() {
        	$(this).blur();
        	fix_ingredient_list();
        });
        $("#sortable-ingredients .ingredient .delete-button").click(function() {
            var delete_checkbox = $(this).children("input");
            if (delete_checkbox.length) {
                $(this).parents("li").hide()
            } else {
                $(this).parents("li").remove();
            }
            delete_checkbox.val("True");
            return false;
        });
        $("#sortable-ingredients .group .delete-button").click(function() {
            $(this).parents("li").remove();
            fix_ingredient_list();
            return false;
        });
        
        $("input.keywords-searchbar").each(function() {
            $(this).autocomplete({
                source: "/ingredients/ing_list/",
                minLength: 2
            });
        });
	}	
    
    $(document).tooltip({ 
        items: ".tooltip-field input,select,textarea", 
        content:  function() {
            return $(this).parent().children('.tooltip').text();
        },
        position: {
            my: "left top",
            at: "right+10 top-2"
        },  
    }).off("mouseover mouseout");
    
    $(document).ready(function() {
        $( "#sortable-ingredients" ).sortable({
            stop: fix_ingredient_list,
            items: "li:not(.sorting-disabled)",
            handle: ".move-handle"
        });
        $( "#sortable" ).disableSelection();
        
        // Sort the ingredient list according to groups, and insert group tags
        fix_ingredient_list();
        
        $(".add-ingredient-button").click(add_ingredient);
        $(".add-ingredientgroup-button").click(add_group);
        
        $(".spinner-wrapper input").spinner();
    });
</script>
{{ recipe_form.media }}
{% endblock %}

{% block recipes-active %}active{% endblock %}

{% block content %}

<div id="edit-recipe">
	<h1>Recept {% if new_recipe %}Toevoegen{% else %}Aanpassen{% endif %}</h1>
	
	<form id="add-recipe-form" action="" method="post" enctype="multipart/form-data">
	  {% if unknown_ingredients %}
	  <p>
	  	U hebt ingredienten opgegeven in het recept die niet teruggevonden werden in onze databank:
	  	<ul>
	  		{% for unknown_ingredient in unknown_ingredients %}
	  		<li>{{ unknown_ingredient }}</li>
	  		{% endfor %}
	  	</ul>
	  	U hebt 3 mogelijkheden:
	  	<ol>
	  		<li>Het recept niet toevoegen</li>
	  		<li>De ongekende ingredienten vervangen door andere, gelijkaardige ingredient die wel in onze databank terug
	  			te vinden zijn</li>
	  		<li>De ongekende ingredienten aanvragen. Uw recept zal opgeslagen worden, maar niet zichtbaar zijn voor andere
	  			gebruikers, tot wij alle ongekende ingredienten in onze databank gestoken hebben. Let op dat dit geen simpel
	  			proces is, en nogal wat tijd in beslag kan nemen.
	  		</li>
	  	</ol>
	  	<input type="submit" value="Annuleren" name="stop-submit" /><input type="submit" value="Ingredi�nten Aanvragen" name="ingrequest-submit" />
	  </p>
	  {% elif new_recipe %}
	  <p>
	      Met dit formulier kan je recepten toevoegen aan Seasoning. Onze software probeert daarna automatisch de huidige voetafdruk
	      van jouw recept te berekenen. 
	  </p>
	  <p>
	      De berekening is enkel mogelijk als alle gebruikte ingrediënten teruggevonden worden in onze databank. Indien
	      dit niet het geval is, krijg je de optie om die niet-gekende ingrediënten aan te vragen. Wij proberen deze dan zo snel
	      mogelijk toe te voegen!
	  </p>
	  {% endif %}
	  
	  <h3>Algemene Informatie</h3>
	  
	  {% csrf_token %}
	  {{ recipe_form.non_field_errors }}
	  
	  <div class="field-wrapper tooltip-field">
	    {{ recipe_form.name.label_tag }}
	    <div class="input-wrapper">
	       {{ recipe_form.name }}
	    </div>
	    <div class="tooltip">{{ recipe_form.name.help_text }}</div>
	    
	    {% if recipe_form.name.errors %}        
	        {{ recipe_form.name.errors }} 
	    {% endif %}
	  </div>
	  
	  <div id="course-field" class="field-wrapper tooltip-field">
	    {{ recipe_form.course.label_tag }}
	    <div class="select-wrapper">
           {{ recipe_form.course }}
        </div>
	    <div class="tooltip">{{ recipe_form.course.help_text }}</div>
	    
	    {% if recipe_form.course.errors %}        
	        {{ recipe_form.course.errors }} 
	    {% endif %}
	  </div>
	  
	  <div id="cuisine-field" class="field-wrapper tooltip-field">
	    {{ recipe_form.cuisine.label_tag }}
	    <div class="select-wrapper">
           {{ recipe_form.cuisine }}
        </div>
	    <div class="tooltip">{{ recipe_form.cuisine.help_text }}</div>
	    
	    {% if recipe_form.cuisine.errors %}        
	        {{ recipe_form.cuisine.errors }} 
	    {% endif %}
	  </div>
	  
	  <div id="description-field" class="field-wrapper tooltip-field">
	    {{ recipe_form.description.label_tag }}
	    <div class="input-wrapper">
           {{ recipe_form.description }}
        </div>
	    <div class="tooltip">{{ recipe_form.description.help_text }}</div>
	    
	    {% if recipe_form.description.errors %}        
	        {{ recipe_form.description.errors }} 
	    {% endif %}
	  </div>
      
      <div id="imageinput-field" class="field-wrapper tooltip-field">
        {{ recipe_form.image.label_tag }}
        <div class="input-wrapper">
           <input id="id_image" type="file" name="image">
        </div>
        <div class="tooltip">{{ recipe_form.image.help_text }}</div>
        
        {% if recipe_form.image.errors %}        
            {{ recipe_form.image.errors }} 
        {% endif %}
      </div>
      
      <div id="imagedisplay-field" class="field-wrapper">
        {% if recipe_form.instance %}
        <div class="select-wrapper">
           <img id="recipe-image" src="{{ recipe_form.instance.image.url }}" />
        </div>
        {% endif %}
      </div>
      
      <br class="clear" />
      <h3>Ingrediënten</h3>
	  
      <div id="portions-field" class="field-wrapper tooltip-field">
	    {{ recipe_form.portions.label_tag }}
	    <div class="spinner-wrapper">
           {{ recipe_form.portions }}
        </div>
	    <div class="tooltip">{{ recipe_form.portions.help_text }}</div>
	    
	    {% if recipe_form.portions.errors %}        
	        {{ recipe_form.portions.errors }} 
	    {% endif %}
	  </div>
      
	  <div id="extra_info-field" class="field-wrapper tooltip-field">
	    {{ recipe_form.extra_info.label_tag }}
	    <div class="input-wrapper">
           {{ recipe_form.extra_info }}
        </div>
	    <div class="tooltip">{{ recipe_form.extra_info.help_text }}</div>
	    
	    {% if recipe_form.extra_info.errors %}        
	        {{ recipe_form.extra_info.errors }} 
	    {% endif %}
	  </div>
	  
	  <div id="ingredient-field" class="field-wrapper tooltip-field">
        <label>Ingrediënten</label>
	  
    	  {% if usesingredient_formset.non_form_errors %}
    	  		<br style="margin-top: 20px;" />
    	  		{{ usesingredient_formset.non_form_errors }} 
    	  {% endif %}
    	  
    	  <div id="uses-formset" class="formset">
    	  	  {% regroup usesingredient_formset by group.value as usesingredient_groups %}
    	      {{ usesingredient_formset.management_form }}
    	      <ul id="sortable-ingredients">
    	          <li class="column-labels sorting-disabled">
    	          	<span class="name-label">Naam</span>
    	          	<span class="amount-label">Hoeveelheid</span>
    	          	<span class="unit-label">Eenheid</span>
    	          	<span class="delete-label">Verwijderen</span>
    	          </li>
    	          {% for group in usesingredient_groups %}
    	      	  {% if group.grouper != "" and group.grouper != None %}
    	          <li class="group">
    	          	<span class="definition">
                        <span class="move-handle"> </span>
                        <span class="delete-button-wrapper">
                            <a href="#" class="delete-button"> </a>
                        </span>
                        <span class="group-name-wrapper">
                            <strong>Ingrediëntgroep: </strong><input type="text" placeholder="(Geef groepsnaam in)" class="group-name" value="{{ group.grouper }}" />
                        </span>
                    </span>
                    <span class="labels">
                        <span class="name-label">Naam</span>
                        <span class="amount-label">Hoeveelheid</span>
                        <span class="unit-label">Eenheid</span>
                        <span class="delete-label">Verwijderen</span>
                    </span>
    	          </li>
    	          {% endif %}
    	          {% for form in group.list %}
    	      	  {{ form.non_field_errors }}
    	      	  {% if forloop.parentloop.last or form.ingredient.value or form.amount.value or form.unit.value %}
    	          <li class="ingredient">
    	          	<span class="move-handle"> </span>
    	          	<span class="ingredient-name">{{ form.id }}{{ form.group }}{{ form.ingredient }}</span>
    	          	<span class="ingredient-amount">{{ form.amount }}</span>
    	          	<span>{{ form.unit }}</span>
    	          	<span><a href="#" class="delete-button">{{ form.DELETE.as_hidden }}</a></span>
    	          	<span class="ingredient-errors">
        	          	<span class="ingredient-name-errors error">{{ form.group.errors }}{{ form.ingredient.errors }}</span>
        	          	<span class="ingredient-amount-errors error">{{ form.amount.errors }}</span>
        	          	<span class="ingredient-unit-errors error">{{ form.unit.errors }}</span>
        	        </span>
    	          	<br class="clear" />
    	          </li>
    	          {% endif %}
    	          {% endfor %}
    	          {% endfor %}
    	          <li class="group empty-form sorting-disabled">
    	            <span class="definition">
        	          	<span class="move-handle"> </span>
        	          	<span class="delete-button-wrapper">
        	          	    <a href="#" class="delete-button"> </a>
        	          	</span>
        	          	<span class="group-name-wrapper">
        	          	    <strong>Ingrediëntgroep: </strong><input type="text" placeholder="(Geef groepsnaam in)" class="group-name" />
        	          	</span>
        	        </span>
        	        <span class="labels">
        	          	<span class="name-label">Naam</span>
        	          	<span class="amount-label">Hoeveelheid</span>
        	          	<span class="unit-label">Eenheid</span>
        	          	<span class="delete-label">Verwijderen</span>
        	        </span>
    	          </li>
    	          <li class="colum-labels empty-form sorting-disabled">
    	          	<span>Naam</span>
    	          	<span>Hoeveelheid</span>
    	          	<span>Eenheid</span>
    	          	<span>Verwijderen</span>
    	          </li>
    	          <li class="ingredient empty-form sorting-disabled">
    	          	<span class="move-handle"> </span>
    	          	<span class="ingredient-name">{{ usesingredient_formset.empty_form.id }}{{ usesingredient_formset.empty_form.group }}{{ usesingredient_formset.empty_form.ingredient }}</span>
    	          	<span class="ingredient-amount">{{ usesingredient_formset.empty_form.amount }}</span>
    	          	<span>{{ usesingredient_formset.empty_form.unit }}</span>
    	          	<span class="delete-button"> </span>
    	          </li>
    	      </ul>
              <div class="button-group">
                  <a href="#" class="add-button add-ingredient-button">Ingrediënt toevoegen</a>
                  <a href="#" class="add-button add-ingredientgroup-button">Ingrediëntengroep toevoegen</a>
              </div>
    	  </div>
    	  
	  </div>
	  
	  <br class="clear" />
	  <h3>Bereiding</h3>
	  
	  <div class="field-wrapper tooltip-field">
	    {{ recipe_form.active_time.label_tag }}
	    <div class="input-wrapper">
           {{ recipe_form.active_time }}
        </div>
	    <div class="tooltip">{{ recipe_form.active_time.help_text }}</div>
	    
	    {% if recipe_form.active_time.errors %}        
	        {{ recipe_form.active_time.errors }} 
	    {% endif %}
	  </div>
	  
	  <div class="field-wrapper tooltip-field">
	    {{ recipe_form.passive_time.label_tag }}
	    <div class="input-wrapper">
           {{ recipe_form.passive_time }}
        </div>
	    <div class="tooltip">{{ recipe_form.passive_time.help_text }}</div>
	    
	    {% if recipe_form.passive_time.errors %}        
	        {{ recipe_form.passive_time.errors }} 
	    {% endif %}
	  </div>
	  
	  <div class="field-wrapper tooltip-field">
	    {{ recipe_form.instructions.label_tag }}
	    <div class="input-wrapper">
           {{ recipe_form.instructions }}
        </div>
	    <div class="tooltip">{{ recipe_form.instructions.help_text }}</div>
	    
	    {% if recipe_form.instructions.errors %}        
	        {{ recipe_form.instructions.errors }} 
	    {% endif %}
	  </div>
	  
	  <input id="submit-btn" type="submit" value="{% if new_recipe %}Toevoegen{% else %}Aanpassen{% endif %}" name="normal-submit" />
    </form>
</div>
{% endblock %}
